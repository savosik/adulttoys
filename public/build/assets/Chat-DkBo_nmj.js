import{j as e}from"./app-JFefIfGz.js";import{a as s,S as t}from"./vendor-inertia-CTBPnMsl.js";import{M as a}from"./MainLayout-kfLYubjd.js";import{r as n}from"./vendor-react-D8ePpywI.js";import{c as r}from"./useStore-DuB4Tk4X.js";const i=r((e,s)=>({messages:{},streamingMessageId:null,streamingContent:"",processingChatId:null,setMessages:(s,t)=>{e(e=>({messages:{...e.messages,[s]:t}}))},addMessage:(s,t)=>{e(e=>({messages:{...e.messages,[s]:[...e.messages[s]||[],t]}}))},setProcessing:s=>{e({processingChatId:s})},stopProcessing:()=>{e({processingChatId:null})},startStreaming:s=>{e({streamingMessageId:s,streamingContent:"",processingChatId:null})},appendStreamingChunk:(s,t,a)=>{e(e=>{const n=e.streamingContent+s;if(t&&a){const s=e.messages[t]||[];if(s.some(e=>e.id===a)){const r=s.map(e=>e.id===a?{...e,content:n}:e);return{streamingContent:n,messages:{...e.messages,[t]:r}}}{const r={id:a,role:"assistant",content:n,created_at:(new Date).toISOString()};return{streamingContent:n,messages:{...e.messages,[t]:[...s,r]}}}}return{streamingContent:n}})},completeStreaming:(s,t,a)=>{e(e=>{const n=(e.messages[s]||[]).map(e=>e.id===t?{...e,content:a}:e);return{messages:{...e.messages,[s]:n},streamingMessageId:null,streamingContent:"",processingChatId:null}})}}));function o(){const[t,a]=n.useState(""),[r,o]=n.useState(null),c=n.useRef(null),l=i(e=>r&&e.messages[r]||[]),d=i(e=>e.streamingMessageId),g=i(e=>e.streamingContent),m=i(e=>e.processingChatId),{addMessage:h,setProcessing:u,setMessages:x,stopProcessing:p}=i(),f=m===r&&!d,j=!!d||f;n.useEffect(()=>{const e=localStorage.getItem("chat_id");e?(o(e),w(e)):(o("init"),x("init",[{id:"init",role:"assistant",content:"Привет! Я ваш ИИ-помощник. Чем могу помочь?"}]));const s=new URLSearchParams(window.location.search).get("message");s&&a(s)},[x]);const w=async e=>{try{const t=await s.get(`/chat/history/${e}`);t.data.length>0?x(e,t.data):x(e,[{id:"init",role:"assistant",content:"Привет! Я ваш ИИ-помощник. Чем могу помочь?"}])}catch(t){}};n.useEffect(()=>{if(!r||"init"===r||!window.Echo)return;const e=`chat.${r}`;return window.Echo.channel(e).listen(".message.streaming",e=>{const s=i.getState();e.message_id===s.streamingMessageId||s.startStreaming(e.message_id),s.appendStreamingChunk(e.chunk,r,e.message_id)}).listen(".message.complete",e=>{s.get(`/chat/history/${r}`).then(s=>{const t=s.data.find(s=>s.id===e.message_id),a=i.getState();t?a.completeStreaming(r,e.message_id,t.content):a.completeStreaming(r,e.message_id,""),x(r,s.data)}).catch(s=>{i.getState().completeStreaming(r,e.message_id,"")})}).error(e=>{}),()=>{window.Echo.leave(e)}},[r,x]),n.useEffect(()=>{var e;null==(e=c.current)||e.scrollIntoView({behavior:"smooth"})},[l,g]);return e.jsxs("div",{className:"flex flex-col h-full bg-gray-50 rounded-lg border border-gray-200",children:[e.jsxs("div",{className:"flex-1 overflow-y-auto space-y-4 p-4",children:[0===l.length&&e.jsx("div",{className:"text-center text-gray-500 mt-10",children:"Start a conversation..."}),l.map(s=>e.jsx("div",{className:"flex "+("user"===s.role?"justify-end":"justify-start"),children:e.jsx("div",{className:"max-w-[80%] rounded-lg p-3 shadow-sm "+("user"===s.role?"bg-blue-600 text-white":"bg-white text-gray-800 border border-gray-200"),children:e.jsx("div",{className:"whitespace-pre-wrap text-sm",children:d===s.id?g:s.content})})},s.id)),f&&!d&&e.jsx("div",{className:"flex justify-start",children:e.jsx("div",{className:"bg-gray-200 text-gray-500 rounded-lg p-3 text-xs italic",children:"Agent is thinking..."})}),e.jsx("div",{ref:c})]}),e.jsx("div",{className:"border-t p-4 bg-white rounded-b-lg",children:e.jsxs("form",{onSubmit:async e=>{if(e&&e.preventDefault(),!t.trim()||j)return;const n=t;a("");try{const e={id:Date.now(),role:"user",content:n,created_at:(new Date).toISOString()},t="init"===r?null:r;t&&h(t,e),t&&u(t);const a=await s.post("/chat/message",{message:n,chat_id:t});if(a.data.chat_id){const s=a.data.chat_id;s!=t&&(o(s),localStorage.setItem("chat_id",s),h(s,e),u(s))}}catch(i){p()}},className:"flex gap-2",children:[e.jsx("input",{type:"text",value:t,onChange:e=>a(e.target.value),placeholder:"Type your message...",disabled:j,className:"flex-1 rounded-full border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50 px-4 py-2 disabled:opacity-50"}),e.jsx("button",{type:"submit",disabled:j,className:"bg-blue-600 text-white p-2 rounded-full hover:bg-blue-700 disabled:opacity-50 transition-colors",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor",className:"w-5 h-5",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5"})})})]})})]})}function c(){return e.jsxs(a,{children:[e.jsx(t,{title:"AI Assistant Chat"}),e.jsx("div",{className:"py-12",children:e.jsx("div",{className:"max-w-7xl mx-auto sm:px-6 lg:px-8",children:e.jsxs("div",{className:"bg-white overflow-hidden shadow-xl sm:rounded-lg h-[600px] flex flex-col",children:[e.jsxs("div",{className:"p-6 border-b border-gray-200",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-800",children:"Чат с ИИ Агентом"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Задайте вопрос о товарах или получите помощь в подборе."})]}),e.jsx("div",{className:"flex-1 overflow-hidden p-6",children:e.jsx(o,{})})]})})})]})}export{c as default};
